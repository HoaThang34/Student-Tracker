{% extends "base.html" %}
{% block title %}Timeline Vi Phạm - {{ student.name }}{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">

    <div class="mb-6">
        <a href="{{ url_for('student_detail', student_id=student.id) }}"
            class="text-indigo-600 hover:text-indigo-700 font-medium">
            <i class="fas fa-arrow-left mr-2"></i> Quay lại chi tiết học sinh
        </a>
    </div>

    <div class="bg-gradient-to-r from-red-600 to-orange-600 rounded-xl shadow-lg p-6 mb-6 text-white">
        <div class="flex items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold mb-2">Timeline Vi Phạm</h1>
                <div class="flex gap-4 text-sm">
                    <span><i class="fas fa-user mr-2"></i>{{ student.name }}</span>
                    <span><i class="fas fa-id-card mr-2"></i>{{ student.student_code }}</span>
                    <span><i class="fas fa-school mr-2"></i>{{ student.student_class }}</span>
                </div>
            </div>
            <div class="text-right">
                <p class="text-sm opacity-90">Điểm rèn luyện hiện tại</p>
                <p class="text-5xl font-bold">{{ student.current_score }}</p>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">

        <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center">
                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-slate-600">Tổng vi phạm</p>
                    <p class="text-2xl font-bold text-slate-800">{{ violations|length }}</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-full bg-orange-100 flex items-center justify-center">
                    <i class="fas fa-list text-orange-600 text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-slate-600">Loại vi phạm</p>
                    <p class="text-2xl font-bold text-slate-800">{{ violations_by_type|length }}</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center">
                    <i class="fas fa-calendar-week text-blue-600 text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-slate-600">Tuần có vi phạm</p>
                    <p class="text-2xl font-bold text-slate-800">{{ violations_by_week|length }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">

        <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
            <h3 class="text-lg font-bold text-slate-800 mb-4">
                <i class="fas fa-chart-bar text-indigo-600"></i> Vi phạm theo tuần
            </h3>
            <canvas id="weekChart"></canvas>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
            <h3 class="text-lg font-bold text-slate-800 mb-4">
                <i class="fas fa-chart-pie text-indigo-600"></i> Loại vi phạm
            </h3>
            <canvas id="typeChart"></canvas>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
        <div class="px-6 py-4 bg-gradient-to-r from-red-50 to-orange-50 border-b border-slate-200">
            <h2 class="text-xl font-bold text-slate-800">
                <i class="fas fa-history text-red-600"></i> Lịch Sử Vi Phạm
            </h2>
        </div>

        {% if violations %}
        <div class="p-6">
            <div class="space-y-4">
                {% for violation in violations %}
                <div class="flex gap-4 p-4 rounded-lg hover:bg-slate-50 transition border border-slate-200">
                    <div class="flex-shrink-0 w-16 text-center">
                        <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center">
                            <i class="fas fa-times text-red-600"></i>
                        </div>
                        <p class="text-xs text-slate-500 mt-1">Tuần {{ violation.week_number }}</p>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-start justify-between">
                            <div>
                                <h4 class="font-semibold text-slate-800">{{ violation.violation_type_name }}</h4>
                                <p class="text-sm text-slate-600 mt-1">
                                    <i class="fas fa-calendar mr-1"></i> {{ violation.date_committed.strftime('%d/%m/%Y
                                    %H:%M') }}
                                </p>
                            </div>
                            <div class="text-right">
    <div class="flex items-center justify-end gap-3">
        <span class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-sm font-semibold">
            -{{ violation.points_deducted }} điểm
        </span>

        <form action="{{ url_for('delete_violation', violation_id=violation.id) }}" method="POST" 
              onsubmit="return confirm('⚠️ CẢNH BÁO:\nBạn có chắc chắn muốn xóa lỗi này?\n\nHệ thống sẽ:\n1. Xóa vi phạm khỏi lịch sử.\n2. HOÀN TRẢ lại {{ violation.points_deducted }} điểm cho học sinh.');"
              class="inline-block">
            <button type="submit" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-400 hover:bg-red-100 hover:text-red-600 transition" title="Xóa lỗi & Hoàn điểm">
                <i class="fas fa-trash-alt"></i>
            </button>
        </form>
    </div>
</div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <div class="p-12 text-center text-slate-500">
            <i class="fas fa-check-circle text-4xl mb-3 text-green-300"></i>
            <p class="font-medium">Chưa có vi phạm nào</p>
            <p class="text-sm">Học sinh này chưa vi phạm nội quy</p>
        </div>
        {% endif %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const weekCtx = document.getElementById('weekChart');
    new Chart(weekCtx, {
        type: 'bar',
        data: {
            labels: {{ week_labels | tojson }},
        datasets: [{
            label: 'Số vi phạm',
            data: {{ week_counts | tojson }},
        backgroundColor: 'rgba(239, 68, 68, 0.7)',
        borderColor: 'rgb(239, 68, 68)',
        borderWidth: 1
            }]
        },
        options: {
        responsive: true,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1 } }
        }
    }
    });

    const typeCtx = document.getElementById('typeChart');
    new Chart(typeCtx, {
        type: 'doughnut',
        data: {
            labels: {{ type_labels | tojson }},
        datasets: [{
            data: {{ type_counts | tojson }},
        backgroundColor: [
            'rgba(239, 68, 68, 0.7)',
            'rgba(251, 146, 60, 0.7)',
            'rgba(245, 158, 11, 0.7)',
            'rgba(234, 179, 8, 0.7)',
            'rgba(132, 204, 22, 0.7)'
        ]
            }]
        },
        options: {
        responsive: true,
        plugins: {
            legend: { position: 'bottom' }
        }
    }
    });
</script>
{% endblock %}