{% extends "base.html" %}
{% block title %}Chi Ti·∫øt H·ªçc Sinh{% endblock %}

{% block content %}
<h2 class="text-3xl font-bold text-gray-800 mb-6">
    Chi Ti·∫øt H·ªçc Sinh: {{ student.name }} (L·ªõp {{ student.student_class }})
</h2>

{% if warning %}
<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6" role="alert">
    <p class="font-bold">C·∫£nh B√°o</p>
    <p>{{ warning }}</p>
</div>
{% endif %}

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md">
        <h3 class="text-xl font-medium text-gray-900 mb-4">Th√¥ng Tin Chung</h3>
        <dl class="space-y-4">
            <div>
                <dt class="text-sm font-medium text-gray-500">H·ªç v√† t√™n</dt>
                <dd class="mt-1 text-lg text-gray-900">{{ student.name }}</dd>
            </div>
            <div>
                <dt class="text-sm font-medium text-gray-500">L·ªõp</dt>
                <dd class="mt-1 text-lg text-gray-900">{{ student.student_class }}</dd>
            </div>
            <div>
                <dt class="text-sm font-medium text-gray-500">ƒêi·ªÉm R√®n Luy·ªán (Hi·ªán t·∫°i)</dt>
                <dd class="mt-1 text-3xl font-bold text-blue-600">{{ student.current_score }}</dd>
            </div>
        </dl>

        <div class="mt-6 pt-6 border-t border-gray-200">
            <a href="{{ url_for('student_transcript', student_id=student.id) }}"
                class="block w-full px-4 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white text-center font-medium rounded-lg shadow-lg hover:from-indigo-700 hover:to-purple-700 transition">
                <i class="fas fa-file-alt mr-2"></i> Xem B·∫£ng ƒêi·ªÉm H·ªçc T·∫≠p
            </a>
            <a href="{{ url_for('student_grades', student_id=student.id) }}"
                class="block w-full mt-2 px-4 py-3 bg-white border-2 border-indigo-600 text-indigo-600 text-center font-medium rounded-lg hover:bg-indigo-50 transition">
                <i class="fas fa-pencil-alt mr-2"></i> Nh·∫≠p ƒêi·ªÉm
            </a>
            <a href="{{ url_for('violations_timeline', student_id=student.id) }}"
                class="block w-full mt-2 px-4 py-3 bg-white border-2 border-red-600 text-red-600 text-center font-medium rounded-lg hover:bg-red-50 transition">
                <i class="fas fa-history mr-2"></i> Timeline Vi Ph·∫°m
            </a>
            <a href="{{ url_for('parent_report', student_id=student.id) }}"
                class="block w-full mt-2 px-4 py-3 bg-gradient-to-r from-green-600 to-teal-600 text-white text-center font-medium rounded-lg shadow-lg hover:from-green-700 hover:to-teal-700 transition">
                <i class="fas fa-file-pdf mr-2"></i> B√°o C√°o Ph·ª• Huynh
            </a>
        </div>
    </div>

    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
        <h3 class="text-xl font-medium text-gray-900 mb-4">Bi·ªÉu ƒê·ªì Xu H∆∞·ªõng Thay ƒê·ªïi ƒêi·ªÉm R√®n Luy·ªán</h3>

        <div class="h-80">
            <canvas id="lineChartStudent"></canvas>
        </div>

    </div>

</div>

<div class="bg-white p-6 rounded-lg shadow-md mt-6">
    <h3 class="text-xl font-medium text-gray-900 mb-4">L·ªãch S·ª≠ Vi Ph·∫°m</h3>
    <ul class="divide-y divide-gray-200">
        {% for vio in student.violations %}
        <li class="py-3 flex justify-between items-center">
            <span class="text-gray-700">Ng√†y {{ vio.date_committed.strftime('%d/%m/%Y') }}: {{ vio.violation_type_name
                }}</span>
            <span class="font-medium text-red-500">-{{ vio.points_deducted }} ƒëi·ªÉm</span>
        </li>
        {% else %}
        <li class="py-3 text-gray-500">Ch∆∞a c√≥ vi ph·∫°m n√†o.</li>
        {% endfor %}
    </ul>
</div>

<div class="bg-white p-6 rounded-lg shadow-md mt-6">
    <h3 class="text-xl font-medium text-gray-900 mb-4">ü§ñ Tr·ª£ L√Ω AI So·∫°n Th·∫£o</h3>
    <p class="text-gray-600 mb-4">S·ª≠ d·ª•ng AI S√°ng t·∫°o (Gemini) ƒë·ªÉ t·ª± ƒë·ªông vi·∫øt nh·∫≠n x√©t g·ª≠i cho ph·ª• huynh d·ª±a tr√™n d·ªØ
        li·ªáu r√®n luy·ªán th·∫≠t c·ªßa h·ªçc sinh.</p>

    <button id="generate-report-btn" data-student-id="{{ student.id }}"
        class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
        T·∫°o Nh·∫≠n X√©t G·ª≠i Ph·ª• Huynh
    </button>

    <div id="report-display" class="mt-4 p-4 border border-gray-200 rounded-md bg-gray-50 hidden">
        <p id="report-text" class="text-gray-800 whitespace-pre-wrap">ƒêang t·∫°o nh·∫≠n x√©t...</p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const ctx = document.getElementById('lineChartStudent');
        if (!ctx || typeof Chart === 'undefined') {
            console.error('Chart.js ch∆∞a s·∫µn s√†ng ho·∫∑c kh√¥ng t√¨m th·∫•y canvas');
            return;
        }

        // D·ªØ li·ªáu ƒë∆∞·ª£c render s·∫µn t·ª´ Flask d∆∞·ªõi d·∫°ng JSON
        const chartLabels = {{ chart_labels | safe
    }};
    const chartScores = {{ chart_scores | safe }};

    try {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'ƒêi·ªÉm r√®n luy·ªán',
                    data: chartScores,
                    borderColor: '#3B82F6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        suggestedMin: 50,
                        suggestedMax: 100
                    }
                }
            }
        });
    } catch (e) {
        console.error('L·ªói v·∫Ω bi·ªÉu ƒë·ªì:', e);
    }
});
</script>

<script>
    const generateBtn = document.getElementById('generate-report-btn');
    const reportDisplay = document.getElementById('report-display');
    const reportText = document.getElementById('report-text');

    generateBtn.addEventListener('click', async () => {
        reportDisplay.classList.remove('hidden');
        reportText.innerText = "ƒêang t·∫°o nh·∫≠n x√©t... (Qu√° tr√¨nh n√†y c√≥ th·ªÉ m·∫•t 5-10 gi√¢y)";
        generateBtn.disabled = true;

        try {
            // ƒê·ªçc ID t·ª´ thu·ªôc t√≠nh data-*
            const studentId = generateBtn.dataset.studentId;

            const response = await fetch(`/api/generate_report/${studentId}`, {
                method: 'POST'
            });

            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.error || `L·ªói t·ª´ server: ${response.statusText}`);
            }

            if (data.report) {
                reportText.innerText = data.report;
            } else {
                reportText.innerText = `L·ªói: ${data.error || 'Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ AI.'}`;
            }

        } catch (error) {
            console.error('L·ªói khi g·ªçi API:', error);
            reportText.innerText = `L·ªói k·∫øt n·ªëi. Vui l√≤ng ki·ªÉm tra Internet v√† th·ª≠ l·∫°i. \n\nChi ti·∫øt: ${error.message}`;
        } finally {
            generateBtn.disabled = false;
        }
    });
</script>
{% endblock %}