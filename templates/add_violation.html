{% extends "base.html" %}
{% block title %}Ghi Nh·∫≠n Vi Ph·∫°m{% endblock %}

{% block content %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
    /* CSS l√†m ƒë·∫πp cho √¥ t√¨m ki·∫øm */
    .select2-container .select2-selection--multiple {
        border: 1px solid #cbd5e1 !important;
        /* slate-300 */
        border-radius: 0.5rem !important;
        /* rounded-lg */
        min-height: 45px;
        padding: 6px;
        background-color: white;
    }

    /* Th·∫ª h·ªçc sinh ƒë√£ ch·ªçn */
    .select2-container--default .select2-selection--multiple .select2-selection__choice {
        background-color: #ffedd5;
        /* cam nh·∫°t */
        border: 1px solid #fdba74;
        /* vi·ªÅn cam */
        color: #9a3412;
        /* ch·ªØ cam ƒë·∫≠m */
        border-radius: 4px;
        padding: 2px 8px;
        font-weight: 600;
        margin-top: 4px;
        margin-right: 6px;
    }

    .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
        color: #9a3412;
        border-right: 1px solid #fdba74;
        margin-right: 6px;
        padding-right: 6px;
    }

    /* Khi focus */
    .select2-container--default.select2-container--focus .select2-selection--multiple {
        border-color: #f97316 !important;
        box-shadow: 0 0 0 1px #f97316;
        outline: none;
    }

    /* Ch·ªânh font ch·ªØ trong dropdown */
    .select2-container--default .select2-results__option--highlighted.select2-results__option--selectable {
        background-color: #f97316;
        color: white;
    }
</style>

<div class="max-w-6xl mx-auto">
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-slate-800">Ghi Nh·∫≠n Vi Ph·∫°m</h1>
        <p class="text-slate-500">H·ªó tr·ª£ qu√©t nhi·ªÅu th·∫ª c√πng l√∫c ho·∫∑c t√¨m ki·∫øm h·ªçc sinh nhanh.</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">

        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
                <div class="w-8 h-8 rounded-lg bg-indigo-100 text-indigo-600 flex items-center justify-center mr-2">
                    <i class="fas fa-images"></i>
                </div>
                Qu√©t Th·∫ª H√†ng Lo·∫°t (OCR)
            </h2>

            <form id="ocr-form" class="space-y-4">
                <div
                    class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center hover:bg-slate-50 transition cursor-pointer relative group">
                    <input type="file" id="ocr_files" name="files[]" multiple accept="image/*"
                        class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                        onchange="updateFileCount(this)">
                    <i
                        class="fas fa-cloud-upload-alt text-4xl text-slate-400 mb-3 group-hover:text-indigo-500 transition"></i>
                    <p class="text-sm text-slate-600 font-medium">K√©o th·∫£ ho·∫∑c ch·ªçn nhi·ªÅu ·∫£nh th·∫ª</p>
                    <p class="text-xs text-slate-400 mt-1" id="file-count-display">Ch∆∞a c√≥ ·∫£nh n√†o ƒë∆∞·ª£c ch·ªçn</p>
                </div>

                <button type="submit" id="ocr-button"
                    class="w-full py-3 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition shadow-md flex items-center justify-center gap-2">
                    <i class="fas fa-magic"></i> Ph√¢n T√≠ch T·∫•t C·∫£
                </button>
            </form>

            <div id="ocr-results-area" class="mt-6 space-y-3 hidden">
                <div class="flex justify-between items-center border-b pb-2">
                    <h3 class="text-sm font-bold text-slate-700">K·∫øt qu·∫£ ph√¢n t√≠ch:</h3>
                    <div class="text-xs text-slate-500">ƒê√£ ch·ªçn: <span id="selected-count"
                            class="font-bold text-indigo-600">0</span></div>
                </div>

                <div id="results-list"
                    class="max-h-60 overflow-y-auto space-y-2 pr-1 custom-scrollbar bg-slate-50 p-2 rounded-lg"></div>

                <div id="batch-actions" class="pt-4 border-t hidden">
                    <form method="POST" action="{{ url_for('add_violation') }}" onsubmit="prepareBatchSubmit(event)">
                        <input type="hidden" name="students_list" id="students_json_input">
                        <label class="block text-sm font-medium text-slate-700 mb-2">√Åp d·ª•ng l·ªói vi ph·∫°m:</label>
                        <div
                            class="bg-slate-50 border border-slate-300 rounded-lg p-4 max-h-48 overflow-y-auto space-y-2 mb-3">
                            {% for rule in rules %}
                            <label
                                class="flex items-center p-2 hover:bg-white rounded-lg cursor-pointer transition group">
                                <input type="checkbox" name="rule_ids[]" value="{{ rule.id }}"
                                    class="w-4 h-4 text-indigo-600 border-slate-300 rounded focus:ring-indigo-500 cursor-pointer">
                                <span
                                    class="ml-3 text-sm font-medium text-slate-700 group-hover:text-indigo-600 flex-1">
                                    {{ rule.name }}
                                </span>
                                <span class="text-xs font-bold text-red-600 bg-red-50 px-2 py-1 rounded">
                                    -{{ rule.points_deducted }}ƒë
                                </span>
                            </label>
                            {% endfor %}
                        </div>
                        <button type="submit"
                            class="w-full py-2.5 bg-emerald-600 text-white rounded-lg font-bold hover:bg-emerald-700 shadow-md transition transform active:scale-95">
                            X√°c Nh·∫≠n & L∆∞u V√†o CSDL
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 h-fit">
            <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
                <div class="w-8 h-8 rounded-lg bg-orange-100 text-orange-600 flex items-center justify-center mr-2">
                    <i class="fas fa-pen"></i>
                </div>
                Nh·∫≠p Nhanh (Ch·ªçn Nhi·ªÅu)
            </h2>

            <form method="POST" action="{{ url_for('add_violation') }}" class="space-y-5">

                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Ch·ªçn H·ªçc Sinh:</label>
                    <select name="student_ids[]" multiple="multiple" id="student-select" class="w-full"
                        style="width: 100%" required>
                        {% for s in students %}
                        <option value="{{ s.id }}">
                            {{ s.student_code }} - {{ s.name }} ({{ s.student_class }})
                        </option>
                        {% endfor %}
                    </select>
                    <p class="text-xs text-slate-400 mt-1">
                        <i class="fas fa-info-circle"></i> G√µ t√™n, m√£ s·ªë ho·∫∑c l·ªõp (VD: "Tuan", "12A1") ƒë·ªÉ l·ªçc.
                    </p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Lo·∫°i Vi Ph·∫°m</label>
                    <div class="bg-slate-50 border border-slate-300 rounded-lg p-4 max-h-64 overflow-y-auto space-y-2">
                        {% for rule in rules %}
                        <label class="flex items-center p-2 hover:bg-white rounded-lg cursor-pointer transition group">
                            <input type="checkbox" name="rule_ids[]" value="{{ rule.id }}"
                                class="w-4 h-4 text-orange-600 border-slate-300 rounded focus:ring-orange-500 cursor-pointer">
                            <span class="ml-3 text-sm font-medium text-slate-700 group-hover:text-orange-600 flex-1">
                                {{ rule.name }}
                            </span>
                            <span class="text-xs font-bold text-red-600 bg-red-50 px-2 py-1 rounded">
                                -{{ rule.points_deducted }}ƒë
                            </span>
                        </label>
                        {% endfor %}
                    </div>
                    <p class="text-xs text-slate-400 mt-1">
                        <i class="fas fa-check-square"></i> Tick ch·ªçn nhi·ªÅu l·ªói vi ph·∫°m c√πng l√∫c
                    </p>
                </div>

                <div class="pt-2">
                    <button type="submit"
                        class="w-full py-3 bg-slate-800 hover:bg-slate-900 text-white rounded-lg font-bold shadow-md transition-all flex justify-center items-center gap-2">
                        <i class="fas fa-check-circle"></i> Ghi Nh·∫≠n Ngay
                    </button>
                </div>
            </form>
        </div>

    </div>
</div>

<script>
    // --- K√çCH HO·∫†T T√åM KI·∫æM ---
    $(document).ready(function () {
        $('#student-select').select2({
            placeholder: "üîç Nh·∫≠p t√™n ho·∫∑c m√£ s·ªë ƒë·ªÉ t√¨m...",
            allowClear: true,
            language: {
                noResults: function () {
                    return "Kh√¥ng t√¨m th·∫•y h·ªçc sinh n√†o";
                }
            }
        });
    });

    // --- CODE X·ª¨ L√ù OCR (GI·ªÆ NGUY√äN) ---
    function updateFileCount(input) {
        const count = input.files.length;
        const text = count > 0 ? `ƒê√£ ch·ªçn ${count} ·∫£nh` : "Ch∆∞a c√≥ ·∫£nh n√†o ƒë∆∞·ª£c ch·ªçn";
        document.getElementById('file-count-display').innerText = text;
        document.getElementById('file-count-display').className = count > 0 ? "text-sm text-indigo-600 font-bold mt-1" : "text-xs text-slate-400 mt-1";
    }

    function updateSelectionCount() {
        const checkedCount = $('.ocr-checkbox:checked').length;
        $('#selected-count').text(checkedCount);
        $('#batch-actions').toggleClass('hidden', checkedCount === 0);
    }

    function prepareBatchSubmit(e) {
        let selectedCodes = [];
        $('.ocr-checkbox:checked').each(function () { selectedCodes.push($(this).val()); });

        if (selectedCodes.length === 0) {
            e.preventDefault();
            alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 h·ªçc sinh!");
            return false;
        }
        $('#students_json_input').val(JSON.stringify(selectedCodes));
        return true;
    }

    $(document).ready(function () {
        $('#ocr-form').on('submit', function (e) {
            e.preventDefault();
            var ocrButton = $('#ocr-button');
            var files = $('#ocr_files')[0].files;

            if (files.length === 0) { alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 ·∫£nh!"); return; }

            var formData = new FormData();
            for (var i = 0; i < files.length; i++) { formData.append('files[]', files[i]); }

            ocrButton.prop('disabled', true).html('<i class="fas fa-circle-notch fa-spin"></i> ƒêang x·ª≠ l√Ω...');
            $('#ocr-results-area').removeClass('hidden');
            $('#results-list').html('<div class="text-center text-slate-500 py-4"><i class="fas fa-spinner fa-spin mr-2"></i>ƒêang g·ª≠i ·∫£nh l√™n server AI...</div>');
            $('#batch-actions').addClass('hidden');

            $.ajax({
                url: '{{ url_for('upload_ocr') }}',
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    $('#results-list').empty();

                    if (response.results && response.results.length > 0) {
                        let hasValid = false;
                        response.results.forEach((item) => {
                            let itemHtml = '';
                            if (item.found) {
                                hasValid = true;
                                let info = item.db_info;
                                itemHtml = `
                                    <label class="flex items-center p-3 bg-white border border-slate-200 rounded-lg hover:bg-indigo-50 transition cursor-pointer group select-none">
                                        <input type="checkbox" value="${info.code}" class="w-5 h-5 rounded border-gray-300 focus:ring-indigo-500 text-indigo-600 cursor-pointer ocr-checkbox" checked onchange="updateSelectionCount()">
                                        <div class="ml-3 flex-1">
                                            <p class="text-sm font-bold text-slate-800 group-hover:text-indigo-700">${info.name}</p>
                                            <p class="text-xs text-slate-500">L·ªõp: ${info.class} ‚Ä¢ M√£: ${info.code}</p>
                                        </div>
                                        <div class="text-emerald-600 text-xs font-bold bg-emerald-50 px-2 py-1 rounded">H·ª£p l·ªá</div>
                                    </label>`;
                            } else {
                                let errorText = item.error ? item.error : 'Kh√¥ng kh·ªõp CSDL';
                                itemHtml = `
                                    <div class="flex items-center p-3 bg-red-50 border border-red-100 rounded-lg opacity-70">
                                        <input type="checkbox" disabled class="w-5 h-5 rounded border-gray-300 bg-slate-100 cursor-not-allowed">
                                        <div class="ml-3 flex-1">
                                            <p class="text-sm font-medium text-red-800 italic">${errorText}</p>
                                            <p class="text-xs text-red-500">File: ${item.file_name}</p>
                                        </div>
                                        <div class="text-red-500 text-xs font-bold"><i class="fas fa-times"></i></div>
                                    </div>`;
                            }
                            $('#results-list').append(itemHtml);
                        });
                        updateSelectionCount();
                        if (!hasValid) $('#results-list').append('<div class="text-center text-red-500 text-sm mt-2">Kh√¥ng t√¨m th·∫•y h·ªçc sinh n√†o h·ª£p l·ªá.</div>');
                    } else {
                        $('#results-list').html('<div class="text-red-500 text-center">L·ªói kh√¥ng c√≥ k·∫øt qu·∫£.</div>');
                    }
                },
                error: function () {
                    $('#results-list').html('<div class="text-red-500 text-center font-bold">‚ùå L·ªói k·∫øt n·ªëi server.</div>');
                },
                complete: function () {
                    ocrButton.prop('disabled', false).html('<i class="fas fa-magic"></i> Ph√¢n T√≠ch T·∫•t C·∫£');
                }
            });
        });
    });
</script>
{% endblock %}