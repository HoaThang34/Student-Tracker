{% extends "base.html" %}
{% block title %}CYB Chatbot{% endblock %}

{% block content %}
<div
    class="h-[85vh] flex flex-col bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200 max-w-4xl mx-auto">
    <div class="bg-indigo-600 p-4 flex items-center justify-between text-white shadow-md z-10">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-indigo-600 shadow-inner">
                <i class="fas fa-robot text-xl"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg leading-tight">Trợ Lý Ảo CYB</h1>
                <p class="text-indigo-200 text-xs flex items-center gap-1">
                    <span class="w-2 h-2 bg-green-400 rounded-full"></span> Trực tuyến
                </p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="clearChat()" class="text-indigo-200 hover:text-white transition"
                title="Bắt đầu cuộc trò chuyện mới">
                <i class="fas fa-trash-alt"></i>
            </button>
            <button onclick="location.reload()" class="text-indigo-200 hover:text-white transition"
                title="Tải lại trang">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>

    <div id="chat-log" class="flex-1 p-6 overflow-y-auto space-y-4 bg-slate-50">
        <div class="flex items-start gap-3">
            <div
                class="w-8 h-8 rounded-full bg-indigo-100 flex-shrink-0 flex items-center justify-center text-indigo-600 text-sm font-bold">
                AI</div>
            <div
                class="bg-white p-3.5 rounded-2xl rounded-tl-none shadow-sm text-slate-700 text-sm max-w-[80%] border border-slate-100">
                Xin chào! Tôi có thể giúp bạn tra cứu điểm số, xem lỗi vi phạm hoặc tạo báo cáo nhận xét học sinh.
            </div>
        </div>
    </div>

    <div class="p-4 bg-white border-t border-slate-200">
        <form id="chat-form" class="flex items-center gap-2">
            <input type="text" id="chat-input"
                class="flex-1 p-3 bg-slate-100 border-transparent rounded-full focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition shadow-inner text-sm"
                placeholder="Nhập tên học sinh hoặc câu hỏi..." autocomplete="off">
            <button type="submit"
                class="w-12 h-12 bg-indigo-600 text-white rounded-full shadow-md hover:bg-indigo-700 hover:shadow-lg transition-all flex items-center justify-center flex-shrink-0">
                <i class="fas fa-paper-plane text-sm"></i>
            </button>
        </form>
    </div>
</div>

<script>
    const chatLog = document.getElementById('chat-log');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');

    chatForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const userMessage = chatInput.value.trim();
        if (userMessage === '') return;

        appendMessage(userMessage, 'user');
        chatInput.value = '';
        sendPayload(userMessage);
    });

    chatLog.addEventListener('click', function (e) {
        if (e.target.classList.contains('chat-button')) {
            const payload = e.target.dataset.payload;
            const label = e.target.innerText;
            appendMessage(label, 'user');
            e.target.closest('.chat-button-group').remove(); // Xóa nút sau khi chọn cho gọn
            sendPayload(payload);
        }
    });

    function sendPayload(payload) {
        // Show loading bubble
        const loadingId = 'loading-' + Date.now();
        const loadingDiv = document.createElement('div');
        loadingDiv.id = loadingId;
        loadingDiv.className = 'flex items-start gap-3';
        loadingDiv.innerHTML = `
            <div class="w-8 h-8 rounded-full bg-indigo-100 flex-shrink-0 flex items-center justify-center text-indigo-600 text-sm font-bold">AI</div>
            <div class="bg-white p-3.5 rounded-2xl rounded-tl-none shadow-sm border border-slate-100">
                <div class="flex space-x-1">
                    <div class="w-2 h-2 bg-slate-300 rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-slate-300 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    <div class="w-2 h-2 bg-slate-300 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                </div>
            </div>`;
        chatLog.appendChild(loadingDiv);
        chatLog.scrollTop = chatLog.scrollHeight;

        fetch("{{ url_for('api_chatbot') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: payload })
        })
            .then(response => response.json())
            .then(data => {
                document.getElementById(loadingId).remove();
                appendMessage(data.response, 'bot', data.buttons || []);
            })
            .catch(error => {
                document.getElementById(loadingId).remove();
                appendMessage('Lỗi kết nối. Xin thử lại.', 'bot');
            });
    }

    function appendMessage(message, sender, buttons = []) {
        const messageDiv = document.createElement('div');
        messageDiv.className = sender === 'user' ? 'flex items-end justify-end gap-2' : 'flex items-start gap-3';

        // Avatar for Bot only
        let avatarHTML = '';
        if (sender !== 'user') {
            avatarHTML = `<div class="w-8 h-8 rounded-full bg-indigo-100 flex-shrink-0 flex items-center justify-center text-indigo-600 text-sm font-bold">AI</div>`;
        }

        const bubbleClass = sender === 'user'
            ? 'bg-indigo-600 text-white rounded-2xl rounded-br-none shadow-md'
            : 'bg-white text-slate-700 rounded-2xl rounded-tl-none shadow-sm border border-slate-100';

        // Format Text
        let formattedMsg = message.replace(/\*\*(.*?)\*\*/g, '<b class="font-bold">$1</b>').replace(/\n/g, '<br>');

        let contentHTML = `
            <div class="flex flex-col items-${sender === 'user' ? 'end' : 'start'} max-w-[85%]">
                <div class="p-3.5 text-sm ${bubbleClass}">${formattedMsg}</div>
            </div>
        `;

        messageDiv.innerHTML = sender === 'user' ? (contentHTML) : (avatarHTML + contentHTML);

        // Buttons
        if (buttons.length > 0) {
            const buttonGroup = document.createElement('div');
            buttonGroup.className = 'flex flex-wrap gap-2 mt-2 ml-11 chat-button-group';
            buttons.forEach(btn => {
                const button = document.createElement('button');
                button.className = 'chat-button px-4 py-1.5 bg-white text-indigo-600 border border-indigo-200 rounded-full text-xs font-semibold hover:bg-indigo-50 hover:border-indigo-400 transition shadow-sm';
                button.innerText = btn.label;
                button.dataset.payload = btn.payload;
                buttonGroup.appendChild(button);
            });
            // Append button group after the message bubble container
            // We need to wrap it properly
            const wrapper = document.createElement('div');
            wrapper.className = 'flex flex-col w-full';
            wrapper.appendChild(messageDiv);
            wrapper.appendChild(buttonGroup);
            chatLog.appendChild(wrapper);
        } else {
            chatLog.appendChild(messageDiv);
        }

        chatLog.scrollTop = chatLog.scrollHeight;
    }

    function clearChat() {
        if (!confirm('Bắt đầu cuộc trò chuyện mới? Lịch sử hiện tại vẫn được lưu trong hệ thống.')) {
            return;
        }

        fetch("{{ url_for('clear_chat_session') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    location.reload();
                }
            })
            .catch(error => {
                console.error('Error clearing chat:', error);
                location.reload();
            });
    }
</script>
{% endblock %}